/*!
 * web
 * 
 *
 * @version v1.0.0
 * @author 
 * @homepage undefined
 * @repository undefined
 * @license ISC
 */
let t=(t,e=!0)=>function(){return this.MATCH(t,(t=>({token:"any",value:t[0],list:[...t],index:t.index,groups:t.groups,hidden:!e})),e)};class e{states=[{input:"",nodes:[],scope:[],level:0}];constructor(t){if(!t)throw new TypeError("input is required");this.getState().input=t}newState(){return this.states.unshift({input:this.getState().input,nodes:[],scope:this.getState().scope,level:this.getState().level})}getState(){return this.states[0]}removeState(){return this.states.shift()}mergeState(t){let e=this.getState();e.input=t.input,e.nodes.push(...t.nodes)}CONSUME(t,{matcher:e,save:s,tag:i}={}){this.newState();let r=this[t].call(this,this),n=this.removeState();return!!r&&(!(e&&!e(r))&&(r.token=t,r.tag=i,s?.(r),n.nodes.push(r),this.mergeState(n),!0))}TOKEN(t,e=t,{tag:s,matcher:i,save:r}={}){this.newState(),this.SKIP();let n=this.MATCH(e),h=this.removeState();return!!n&&(!(i&&!i(n))&&(n.token=t,n.tag=s,r?.(n),h.nodes.push(n),this.mergeState(h),!0))}RULE(t,{tag:e,name:s}={}){return this.GROUP(s||t,this[t],{tag:1==e?t:e||void 0})}GROUP(t,e,{tag:s}={}){this.newState();let i=e.call(this,this),r=this.removeState();if(!i)return!1;let n={rule:t,nodes:r.nodes,tag:s};return r.nodes.forEach((t=>{t.tag&&(n[t.tag]=t)})),"object"==typeof i&&(n={...n,...i}),r.nodes=[n],this.mergeState(r),!0}MANY(t,{required:e=!1,name:s,tag:i,gate:r}={}){this.newState();let n=!e;for(;(r?.()??1)&&t.call(this);)n=!0;let h=this.removeState();if(!n)return!1;if(s){let t={rule:s,nodes:h.nodes,tag:i?!0===i?s:i:void 0};"object"==typeof n&&(t={...t,...n}),h.nodes=[t]}return this.mergeState(h),!0}OP(t){return t.call(this),!0}MATCH(t,e=(t=>({token:"any",value:t[0],list:[...t],index:t.index,groups:t.groups})),s=!0){s&&this.SKIP();let i=this.getState(),r=i.input.match(new RegExp(`^(?:${t.source||t})`));if(r)return i.input=i.input.slice(r[0].length),e(r)}SKIP(){return!0}}class s extends e{JsBlockComment=t(/\/\*[^]*?\*\//,!1);JsLineComment=t(/\/\/.*/,!1);BlockComment=t(/###([^]*?)###/,!1);LineComment=t(/#(.*)/,!1);Number=t(/[\d_]+(\.[\d_]+)?([eE][+-]?[0-9_]+)?/);Complex=t(/[\d_]+(\.[\d_]+)?([eE][+-]?[0-9_]+)?[ij]/);String=t(/"(?:\\["\\]|[^"\\])*"|'(?:\\['\\]|[^'\\])*'/);Newline=t(/\n/,!1);Ws=t(/[ \t]+/,!1);Id=t(/\w[\w\d]*/);Punc=t(/[~!@#$%^&*_+=\-[\]\\{}|;:,./<>?]/);EOF(){return 0===this.getState().input.length}}class i extends s{SKIP(t=!1){for(;this.CONSUME("Ws")||this.CONSUME("BlockComment")||this.CONSUME("LineComment")||this.CONSUME("JsLineComment")||this.CONSUME("JsBlockComment")||t&&this.CONSUME("Newline"););return!0}static parse(t){let e=new i(t);if(e.RULE("Program"),e.getState().input)throw new Error("Failed to parse input.");return e.getState().nodes[0]}Program(){for(;this.Statement(););return!0}Statement(){return this.SKIP(!0),this.RULE("ForStat")||this.RULE("AssignStat")||this.RULE("FuncStat")||this.RULE("ComplexStat")||this.RULE("ImportStat")||this.RULE("ExprStat")}Block(){return this.SKIP()&&this.CONSUME("Newline")&&this.MANY((()=>this.CONSUME("Indent")&&this.Statement()))}ForStat(){return this.TOKEN("for")&&this.RULE("ForArgs")&&this.RULE("ExprList")&&this.RULE("Block")}ForArgs(){let t=[];if(this.CONSUME("Id",{save:e=>{this.getState().scope.includes(e.value)||(this.getState().scope.push(e.value),t.push(e.value))}})&&this.MANY((()=>this.TOKEN("Comma",",")&&this.OP((()=>this.CONSUME("Id")))))&&this.TOKEN("in"))return{declarators:t}}ComplexStat(){return this.TOKEN("ComplexToken",/if|else|switch|catch|do|while/)&&this.OP((()=>this.RULE("ExprList",{name:"Test"})))&&this.RULE("Block")}FuncStat(){return this.TOKEN("Function","function")&&this.Id()&&this.RULE("ParensExpr",{name:"Params"})&&this.OP((()=>this.SKIP()))&&this.RULE("Block")}ParensExpr(){return this.TOKEN("LP ",/\(/)&&this.OP((()=>this.ExprList()&&this.SKIP()))&&this.TOKEN("RP ",/\)/)}ExprStat(){return this.ExprList()&&this.OP((()=>this.SKIP()))&&(this.EOF()||this.CONSUME("Newline"))}ImportStat(){return this.TOKEN("Import","import")&&this.MANY((()=>this.SimpleExpr()),{gate:()=>{this.newState(),this.SKIP();let t=!this.EOF()&&!this.CONSUME("Newline")&&!this.TOKEN("From","from");return this.removeState(),t},required:!0})&&this.TOKEN("From","from")&&this.CONSUME("String",{tag:"import_string"})&&this.EndStat()}EndStat(){return this.OP((()=>this.SKIP()))&&(this.EOF()||this.CONSUME("Newline"))}AssignStat(){return this.MANY((()=>this.RULE("AssignExpr")),{required:!0})&&this.RULE("ExprList")&&this.EndStat()}AssignExpr(){let t=!1,e="",s=[],i=e=>{t||this.getState().scope.includes(e)||(this.getState().scope.push(e),s.push(e))};if(this.MANY((()=>this.CONSUME("Id",{save:t=>{e=t.value},tag:"var"})||this.TOKEN("Comma",",",{save:()=>{e&&i(e),e="",t=!1}})||(t=this.SimpleExpr())),{required:!0,gate:()=>{this.newState();let t=!this.TOKEN("Assign","=");return this.removeState(),t}})&&this.TOKEN("Assign","=",{save:()=>{e&&i(e)}}))return{declarators:s}}ExprList(){return this.MANY((()=>this.RULE("ParensExpr")||this.SimpleExpr()),{required:!0,gate:()=>{this.newState(),this.SKIP();let t=!this.EOF()&&!this.CONSUME("Newline");return this.removeState(),t}})}SimpleExpr(){return this.CONSUME("Number")||this.CONSUME("String")||this.CONSUME("Id")||this.CONSUME("Punc")}Indent(){let t;for(;this.CONSUME("Ws",{save:e=>t=e})||this.CONSUME("BlockComment")||this.CONSUME("LineComment")||this.CONSUME("JsLineComment")||this.CONSUME("JsBlockComment")||this.CONSUME("Newline",{save:()=>t=void 0}););if(!t)return!1;let e=t?.value.length??0;if(!(e<this.getState().level))return e>this.getState().level&&(this.getState().level=e),{token:"indent",value:t?.value,list:t?.list,hidden:!0};this.getState().level=e}}class r{VISIT_SINGLE(t){let e=this[t.rule||t.token];if(!e){if(t.token)return this.TOSTR(t);throw new Error(`No visitor for ${t.rule||t.token}`)}return e.call(this,t)}VISIT(t){return Array.isArray(t)?t.map((t=>this.VISIT_SINGLE(t))):this.VISIT_SINGLE(t)}TOSTR(t){return t.token?t.value:this.VISIT(t.nodes).join("")}AssignExpr(t){return[t.declarators,t.nodes.map((t=>"Assign"==t.token?"=":this.TOSTR(t)),this).join("")]}AssignStat(t){let e=[],s=t.nodes.map((t=>{if("AssignExpr"==t.rule){let[s,i]=this.AssignExpr(t);return e.push(...s),i}return this.TOSTR(t)})).join("");return e.length&&(s="let "+e.join()+";"+s),s}Program=this.TOSTR;ForStat(t){let e=[],s="";return s+=t.nodes.map((t=>"for"==t.token?"for(":"ForArgs"==t.rule?([e,s]=this.VISIT(t),s):"Block"==t.rule?")"+this.VISIT(t):this.VISIT(t))).join(""),e.length&&(s="let "+e.join()+";"+s),s}ImportStat(t){return t.nodes.map((t=>"Import"==t.token?"import{":"From"==t.token?"}from":this.TOSTR(t))).join("")}ForArgs(t){return[t.declarators,t.nodes.map((t=>"in"==t.token?"of":this.VISIT(t))).join("")]}ComplexStat=this.TOSTR;Block(t){return"{"+this.TOSTR(t).replace(/\n?$/,"}$&")}Test(t){return"("+this.TOSTR(t)+")"}ExprStat(t){let e=t.nodes.map((t=>"ExprList"==t.rule?this.ExprList(t):this.VISIT_SINGLE(t))).join("");return e.endsWith("\n")||(e+="\n"),e}FuncStat=this.TOSTR;ExprList=this.TOSTR;ParensExpr=this.TOSTR;Params=this.TOSTR;Indent(){return""}JsBlockComment=this.TOSTR;JsLineComment=this.TOSTR;BlockComment(t){return"/*"+t.list[1]+"*/"}LineComment(t){return"//"+t.list[1]}String(t){return"`"+t.value.slice(1,-1)+"`"}static visit(t){return(new r).VISIT(t)}static convert(t){return r.visit(i.parse(t))}}const n=i.parse,h=r.convert;export{e as BaseParser,i as Parser,r as ToJs,t as Token,n as parse,h as tojs};
